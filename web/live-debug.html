<!DOCTYPE html>
<html>
<head>
    <title>File Upload Live Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .debug-panel { display: flex; gap: 20px; }
        .left-panel { flex: 1; }
        .right-panel { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 5px; }
        .step { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step.active { border-color: #007bff; background: #f0f8ff; }
        .step.complete { border-color: #28a745; background: #f0fff0; }
        .step.error { border-color: #dc3545; background: #fff0f0; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .file-preview { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .log { background: #212529; color: #00ff00; padding: 15px; font-family: monospace; font-size: 12px; height: 400px; overflow-y: auto; border-radius: 3px; white-space: pre-wrap; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; color: white; z-index: 1000; }
        .notification.info { background: #17a2b8; }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #212529; }
        input[type="text"] { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç File Upload Live Debug Tool</h1>
    
    <div class="debug-panel">
        <div class="left-panel">
            <div class="step" id="step1">
                <h3>Step 1: File Selection</h3>
                <input type="file" id="file-input" accept="image/*,.pdf,.txt,.md,.doc,.docx">
                <button class="btn-primary" onclick="selectFile()">Process Selected File</button>
                <div id="file-preview"></div>
            </div>
            
            <div class="step" id="step2">
                <h3>Step 2: Message Input</h3>
                <input type="text" id="message-input" placeholder="Enter message (optional)" value="What do you see in this file?">
                <button class="btn-primary" onclick="prepareMessage()">Prepare Message</button>
                <div id="message-preview"></div>
            </div>
            
            <div class="step" id="step3">
                <h3>Step 3: Send to Server</h3>
                <button class="btn-success" onclick="sendToServer()" id="send-btn" disabled>Send File & Message</button>
                <div id="send-result"></div>
            </div>
            
            <div class="step">
                <h3>Quick Actions</h3>
                <button class="btn-danger" onclick="clearAll()">Clear All</button>
                <button onclick="testConnection()">Test Connection</button>
                <button onclick="clearLog()">Clear Log</button>
            </div>
        </div>
        
        <div class="right-panel">
            <h3>Live Debug Log</h3>
            <div id="debug-log" class="log">Debug tool loaded - ready for testing...\n</div>
        </div>
    </div>
    
    <script>
        let selectedFile = null;
        let processedFileData = null;
        let messageData = null;
        let requestData = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const colors = {
                info: '#00ff00',
                error: '#ff6b6b',
                warning: '#ffd93d',
                success: '#6bcf7f'
            };
            logDiv.innerHTML += `<span style="color: ${colors[type] || colors.info}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        function setStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
        }
        
        function clearLog() {
            document.getElementById('debug-log').innerHTML = 'Log cleared...\n';
        }
        
        function clearAll() {
            selectedFile = null;
            processedFileData = null;
            messageData = null;
            requestData = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview').innerHTML = '';
            document.getElementById('message-preview').innerHTML = '';
            document.getElementById('send-result').innerHTML = '';
            document.getElementById('send-btn').disabled = true;
            setStepStatus('step1', '');
            setStepStatus('step2', '');
            setStepStatus('step3', '');
            log('All data cleared', 'warning');
        }
        
        async function selectFile() {
            const fileInput = document.getElementById('file-input');
            
            if (!fileInput.files[0]) {
                showNotification('Please select a file first', 'warning');
                return;
            }
            
            selectedFile = fileInput.files[0];
            setStepStatus('step1', 'active');
            log(`Processing file: ${selectedFile.name}`);
            log(`File size: ${selectedFile.size} bytes`);
            log(`File type: ${selectedFile.type}`);
            
            try {
                // Convert to base64
                const base64Data = await fileToBase64(selectedFile);
                log(`Base64 conversion successful: ${base64Data.length} chars`);
                
                // Check decoded size
                const decodedData = atob(base64Data);
                const actualSize = decodedData.length;
                log(`Original size: ${selectedFile.size}, Decoded size: ${actualSize}`);
                
                if (selectedFile.size !== actualSize) {
                    log(`Size mismatch detected - using decoded size: ${actualSize}`, 'warning');
                }
                
                // Create file data object
                processedFileData = {
                    file_id: 'live-debug-' + Date.now(),
                    filename: selectedFile.name,
                    content_type: selectedFile.type,
                    file_size: actualSize, // Use decoded size
                    file_data: base64Data,
                    file_category: getFileCategory(selectedFile.type)
                };
                
                // Show preview
                document.getElementById('file-preview').innerHTML = `
                    <div class="file-preview">
                        <strong>‚úÖ File processed successfully</strong><br>
                        Name: ${processedFileData.filename}<br>
                        Size: ${processedFileData.file_size} bytes<br>
                        Type: ${processedFileData.content_type}<br>
                        Category: ${processedFileData.file_category}<br>
                        ID: ${processedFileData.file_id}
                    </div>
                `;
                
                setStepStatus('step1', 'complete');
                log('File processing completed successfully', 'success');
                
            } catch (error) {
                log(`File processing failed: ${error.message}`, 'error');
                setStepStatus('step1', 'error');
                showNotification('File processing failed', 'error');
            }
        }
        
        function prepareMessage() {
            if (!processedFileData) {
                showNotification('Please process a file first', 'warning');
                return;
            }
            
            setStepStatus('step2', 'active');
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            log('Preparing message and request data...');
            
            // Create request data
            requestData = {
                message: message || 'Please analyze this file',
                files: [processedFileData],
                conversation_id: 'debug-conv-' + Date.now(),
                model: 'gemma3:latest',
                vision_model: 'llava:latest',
                auto_analyze_files: true,
                max_tokens: 1000,
                temperature: 0.7
            };
            
            log(`Message: "${requestData.message}"`);
            log(`Files count: ${requestData.files.length}`);
            log(`Request size: ${JSON.stringify(requestData).length} characters`);
            
            // Show preview
            document.getElementById('message-preview').innerHTML = `
                <div class="file-preview">
                    <strong>‚úÖ Request prepared</strong><br>
                    Message: "${requestData.message}"<br>
                    Files: ${requestData.files.length}<br>
                    Model: ${requestData.model}<br>
                    Vision Model: ${requestData.vision_model}<br>
                    Request Size: ${JSON.stringify(requestData).length} chars
                </div>
            `;
            
            setStepStatus('step2', 'complete');
            document.getElementById('send-btn').disabled = false;
            log('Message preparation completed', 'success');
        }
        
        async function sendToServer() {
            if (!requestData) {
                showNotification('Please prepare message first', 'warning');
                return;
            }
            
            setStepStatus('step3', 'active');
            log('Sending request to server...');
            
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            try {
                log('Making fetch request to /api/files/chat-with-files');
                log('Request headers: Content-Type: application/json');
                
                const startTime = Date.now();
                const response = await fetch('/api/files/chat-with-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const requestTime = Date.now() - startTime;
                log(`Response received in ${requestTime}ms`);
                log(`Status: ${response.status} ${response.statusText}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log('Response parsing successful', 'success');
                    log(`AI Response length: ${result.response.length} characters`);
                    log(`Processing time: ${result.processing_time_ms}ms`);
                    
                    document.getElementById('send-result').innerHTML = `
                        <div class="file-preview" style="background: #d4edda;">
                            <strong>‚úÖ Upload successful!</strong><br>
                            Processing time: ${result.processing_time_ms}ms<br>
                            Response length: ${result.response.length} chars<br>
                            Model used: ${result.model_used}<br>
                            <details style="margin-top: 10px;">
                                <summary>AI Response</summary>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 3px;">
                                    ${result.response}
                                </div>
                            </details>
                        </div>
                    `;
                    
                    setStepStatus('step3', 'complete');
                    showNotification('File upload successful!', 'success');
                    log('=== UPLOAD COMPLETED SUCCESSFULLY ===', 'success');
                    
                } else {
                    const errorText = await response.text();
                    log(`Server error: ${response.status} ${response.statusText}`, 'error');
                    log(`Error details: ${errorText}`, 'error');
                    
                    document.getElementById('send-result').innerHTML = `
                        <div class="file-preview" style="background: #f8d7da;">
                            <strong>‚ùå Upload failed</strong><br>
                            Status: ${response.status} ${response.statusText}<br>
                            Error: ${errorText}
                        </div>
                    `;
                    
                    setStepStatus('step3', 'error');
                    showNotification('Upload failed', 'error');
                }
                
            } catch (error) {
                log(`Network/fetch error: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                
                document.getElementById('send-result').innerHTML = `
                    <div class="file-preview" style="background: #f8d7da;">
                        <strong>‚ùå Network error</strong><br>
                        Error: ${error.message}
                    </div>
                `;
                
                setStepStatus('step3', 'error');
                showNotification('Network error', 'error');
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send File & Message';
            }
        }
        
        async function testConnection() {
            log('Testing server connection...');
            try {
                const response = await fetch('/api/chat/health');
                if (response.ok) {
                    const data = await response.json();
                    log('Server connection: OK', 'success');
                    showNotification('Server connected', 'success');
                } else {
                    log(`Server connection failed: ${response.status}`, 'error');
                    showNotification('Server connection failed', 'error');
                }
            } catch (error) {
                log(`Connection test failed: ${error.message}`, 'error');
                showNotification('Connection failed', 'error');
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
        
        function getFileCategory(contentType) {
            if (contentType.startsWith('image/')) return 'image';
            if (contentType.startsWith('text/') || contentType.includes('pdf') || contentType.includes('document')) return 'document';
            return 'other';
        }
        
        // Initialize
        log('Live debug tool ready');
        log('1. Select a file');
        log('2. Prepare message');
        log('3. Send to server');
    </script>
</body>
</html>
